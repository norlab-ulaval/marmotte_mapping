<launch>
    <arg name="folder" default="/home/mbo/norlab_ws/data"/>
    <arg name="bagfile_name" default="empty1_2022-05-05-19-14-33"/>
    <arg name="rate" default="1.0"/>

    <node pkg="norlab_icp_mapper_ros" type="mapper_node" name="mapper_node" output="screen" respawn="false">
        <remap from="points_in" to="velodyne_points_deskewed"/>
        <param name="robot_frame" value="base_link"/>
        <param name="odom_frame" value="odom"/>
<!--        <param name="icp_config" value="$(find marmotte_mapping)/params/empty_icp_config.yaml"/>-->
        <param name="icp_config" value="$(find marmotte_mapping)/params/realtime_icp_config.yaml"/>
        <param name="input_filters_config" value="$(find marmotte_mapping)/params/realtime_input_filters.yaml"/>
        <param name="map_post_filters_config" value="$(find marmotte_mapping)/params/realtime_post_filters.yaml"/>
        <param name="map_update_condition" value="delay"/>
        <param name="map_update_delay" value="0"/>
        <param name="sensor_max_range" value="120"/>
        <param name="min_dist_new_point" value="0.05"/>
        <param name="compute_prob_dynamic" value="true"/>
        <param name="map_tf_publish_rate" value="20"/>

        <param name="max_idle_time" value="60" />

        <param name="beam_half_angle" value="0.017453292" /> <!-- 0.01 -->

        <param name="publish_tfs_between_registrations" value="true"/>

        <param name="is_online" value="true"/>

        <param name="final_map_file_name" value="$(arg folder)/results/$(arg bagfile_name)_map.vtk"/>
        <param name="final_trajectory_file_name" value="$(arg folder)/results/$(arg bagfile_name)_traj.vtk"/>
    </node>

    <node pkg="static_transform_mux" type="static_transform_mux" name="static_transform_mux">
    </node>

<!--     Static TF publisher-->
    <include file="$(find marmotte_description)/launch/description.launch"/>

    <node pkg="norlab_imu_tools" type="imu_and_wheel_odom_node" name="imu_and_wheel_odom_node" output="screen" respawn="true">
        <remap from="imu_topic" to="/MTI_imu/data" />
        <remap from="wheel_odom_topic" to="/odom" />
        <param name="odom_frame" value="odom" />
        <param name="base_frame" value="base_link" />
        <param name="publish_translation" value="True" />
        <param name="wheel_odom_velocity_scale_x" value="1.0" />

        <rosparam param="imu_correction_rpy">[0.00418879, -0.00254, 0.0]</rosparam> ## final from paraview

        ## If odom message needed
        <param name="publish_odom" value="true" />
        <param name="odom_topic_name" value="imu_and_wheel_odom" />
    </node>

    <node pkg="rosbag" type="play" name="rosbag_play" output="screen" required="true"
          args="--clock --quiet -r $(arg rate) $(arg folder)/bagfiles/$(arg bagfile_name).bag"
    />

    <node pkg="utils" type="localization_monitor.py" name="localization_monitor">
        <param name="log_folder" value="$(arg folder)/results"/>
    </node>

    <node pkg="rosbag" type="record" name="rosbag_record" output="screen"
          args="record -O $(arg folder)/results/$(arg bagfile_name)_traj /icp_odom"
    />
</launch>
